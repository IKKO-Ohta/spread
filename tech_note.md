# 対戦管理・分析アプリケーション spread をセルフホスティングしよう

 こんにちは！ 太田 一行(@samayotta)です。  
 
 今回はMixi Tech Noteのスペースをお借りして、私が作成したアプリケーション spread の紹介をさせていただける機会を得ました。簡単に紹介すると、このアプリケーションは対人ゲーム（特にTCG/DCG カードゲーム）の対戦記録をチームで管理共有し、結果を分析するためのオープンソースソフトウェアです。この記事では本アプリケーションを内容と技術の面から紹介し、さらにセルフホスティングする手順を紹介するものです。   
 
## 対戦管理・分析アプリケーション spread について

 ### イントロダクション

  いま、カードゲームの世界には大きな変化が訪れています。e-sportsの流行を背景に、非常に多くの人がカードゲームをプレイしています。高額な賞品・賞金が用意されたゲームも少なくありません。プレイヤーたちはみな、インターネットで調べた情報をもとに、勝てる流行のデッキを選択する傾向を強くしています。そして流行は瞬く間に移り変わります。そのなかを勝ち抜くには、オリジナルデッキを構築して鍛え上げていくのと同じくらい、 流動的なメタゲームを俯瞰して分析・把握できる力、すなわち（あればサイドボーディングも含めて）流行に対してもっとも優れたデッキを選べる力が、トーナメントシーンでは求められるようになってきています。
 
  ひとつの解決策として考えられるのは、いわゆる「チーム制」です。限られた複数人数で網羅的にゲームをプレイし、メタゲームをしらみ潰しに解析しようとする動きと言い換えることもできます。たとえば、MTGのプロプレイヤーである佐藤レイ選手は、自身で・・・。そこで使用されているGoogle スプレッドシートは次のようなものです。

  私はこのアイデアに納得し、早速自分でも取り入れようとしましたが、すぐに挫折してしまいました。というのも、スマートフォンから気軽に編集することもできないし、集計には職人的なスプレッドシート作成の技術が必要になります。さらに、カードゲーム全般に使用できるような一般性を持った仕組みになっていないと感じました。

  こういう理由で作成したのがspreadです。スマートフォンから気軽に対戦結果を投稿でき、集計するにもスプレッドシート作成の技術が必要ありません。そしてカードゲーム全般に使用できるような一般性を備えています。もちろん、上記のGoogle スプレッドシートで実現できていた閲覧管理（見せる人を制限する）機能や、集計する機能を備えています。
  
 ### なにができるか 

 #### 1. 対戦記録の投稿   

 これが対戦記録の投稿画面、結果が格納されたページです。

（スクリーンショット）
（機能の紹介）

 #### 2. 対戦記録の分析

 これが分析のためのページです。

（スクリーンショット）
（機能の紹介）

 ### スクリーンショット

 ### ホスティングについて
 spreadはサーバ用のものも含めて全てのソースコードがMITライセンスのもとで公開されています。また、僕自身がホスティングしたサイト (URL）にアクセスして完全無料で利用できます。しかしもちろん、自分でホスティングすることもできます。たとえば独自カスタマイズを施したspreadを使用したい場合、ホスト主に対戦情報等を預けたくない場合などには、自分オリジナルのspreadをホスティングする必要があるでしょう。
 この記事を読むと、spreadを構成している技術に加えてホスティングの方法について一通りの知識を得ることができます。最後まで実行しおえると、自分だけのspread サイトを持てるようになっているはずです。

 ### ライセンス
 上述のように、このアプリケーションのライセンスはMITです。このソフトウェアは完全に無料に使用でき、許諾なしに改造したり有償で販売することも可能です。ただし、著作権表示は明記しなければなりません。またソフトウェアの利用にあたって、作者である私(@samayotta)は一切の責任を負いません。

## spreadの技術的概要

もっとも端的にspreadについて説明すると、**バックエンドにFirestoreを採用したサーバレス Nuxt.js シングルページアプリケーション** です。以下はこのことをもう少し噛み砕いて説明するものであり、（今後もしかしたら現れるかもしれない）コミッタに向けて残す開発資料でもあります。

### フロントエンド: Nuxt.js

Nuxt.jsは、フロントエンドフレームワークの一つで、Vue.jsによるウェブアプリ制作を洗練されたアーキテクチャで行えるようにするものです。ReactによるNext.jsについで人気のあるフレームワークで、2020年1月現在、GitHubのスター数は現在24.9Kとなっています。

spreadはNuxt.jsの機能に全面的に依存して構築されています。色々な局面で面倒な作業をショートカットできるのがありがたく、開発にかかる時間を大幅に短縮できています。また、優れたアーキテクチャのおかげでリポジトリの状態をクリーンに保ち続けることができること、Nuxt.js（というかフロントエンド フルスタックフレームワーク全般）に知見のあるエンジニアであれば全体をすぐに把握できることなどのメリットも重要です。

Nuxt.jsに、さらに次の２点を加えて開発効率を向上させています。

1. TypeScriptによる型安全化  
 リーダビリティの高さ、VS Codeによる強力な補完機能、プログラミング中の思考が型という抽象的な次元でより整理されることなどのメリットから、もはやTypeScriptなしの実装はありえないと考えています。さらに、Spreadでは各種decoratorライブラリを用いて型安全の度合いを高めています。
    - vue-property-decorator  
      クラススタイルVueをTypeScriptとして扱うためのデコレータライブラリで、特に`@Prop`や`@Emit`などの情報を型安全に取り扱うのに貢献します。オリジナルの記法は`data`プロパティの管理が面倒だし、コードのルックスがReactと似て多くの人にとっつきやすいなどの理由で、クラススタイルVueの採用自体は迷わず決めていました。
    - vuex-property-decorator  
      VuexをTypeScriptとして扱うためのライブラリです。Vuexストアを型安全に作成すること、Vuexクラスのメソッドをアノテートして`Mutation`や`Action`についての性質を維持すること（Vuexのメソッドに本来的な役割を維持させること）、`getModules`を利用して型安全にそして補完可能な仕方でコード中にVuexを呼び出せることなどから、TypeScriptの良さを活かせると考えています。spreadの実装では、ページコンポーネントの一番ベースのMixinに、`getModules`経由で取得した各ストアへのアクセサを登録しています。
  
2. Vuexのクリーンな利用  
 いわゆる`クリーンアーキテクチャ`をゆるく採用しています。Vuexにはビジネスロジックに関連する情報を保持するようにし、Firestoreとの通信部分（データベースの更新、API通信）も全てこれに集約するようにしています。propsバケツリレーを減らす、コンポーネント単位での単体テストをより楽にする、また通信部分の改変をやりやすくするなどの恩恵が受けられます。

上記の内容を把握した上でコードを読んでいただくとより全体が見通しやすいと考えています。

 footnote: SSR不採用について  
 なお、Nuxt.js は **サーバサイド レンダリング** をVue.jsで容易に実装できる点でも注目されています。   
 **サーバサイド レンダリング** とは、ざっくりとした説明では、事前にサーバとしてHTMLを作成し送信、それを追いかけるようにブラウザ内でJavaScriptの一部を読み込み動的な振る舞いを行えるようにするレンダリング方法です。ユーザは一足先にHTMLの文章を読めるのでTime To Content(何らかの意味のあるコンテンツにアクセスできるまでの時間)が短縮できます。ただしspreadでは、Time To Contentの改善が要件上クリティカルでないこと、必然的にレンダリングを行うためのNode.js サーバを要求するので運営する手間が増えることから、この機能を採用しませんでした。

### バックエンド: Firestore

spreadは"サーバレス"なアプリケーションですが、本当にサーバ的な処理を何にも行なっていないのかといえばそうではありません。実際、投稿されたデータの保存と取得、認証、招待メールの送信といった操作はサーバで行うのが自然です。そこで、自前でコードを書かず、Google Firestoreというサービスを利用し、最低限必要な機能をまかなっています。

 - 現在はFirebaseの無料プランで運用しています。もしこれがいっぱいになるようなら有料プラン(Blaze)に切り替えるでしょう。世界じゅうのカードゲーマーが使ったと仮定してもFirebaseで賄えないような超大規模プロダクトにはなりようがないと判断しています。
 - Firebaseを用いる副次的なメリットとして、バックエンド側のコードを一つにまとめられるという良さもあります。すなわち、あたかもIDLで定義したかのように、フロント側で作成したTypeScriptの型定義を一部の機能で使いまわせるということです。さらに、サーバコードを含む場合であってもいくつかのコマンドを叩くだけで済むくらいデプロイ手順が簡略化されるため、今回のようにセルフ ホスティングを想定する場合に向いています。

  footnote:  
  今回のアプリケーション作成にあたって、投稿されたデータの保存と取得、認証、招待メールの送信の三点以外、サーバでの処理が必須なものはありません。Google FirebaseやAWS Amplify等のサービスを使うのが、インフラ管理の手間などを考えても合理的な判断だと考えています。

 #### データ構造： Firebase Cloud Firestore

 このアプリのfirestoreデータ構造は次のようになっています。
 ```
  spread---{sheetId}---games---{gameId}
 ```

 せっかくTypeScriptの型定義をサーバコードでも使いまわしているので、シートおよびゲームについては**インターフェイス定義** を掲載しておきます。
 ```typescript
 interface Sheet {}
 ```

```typescript
interface Game {}
 ```
 
#### 認証: Firebase Authentification

認証にはFirebase Authentificationを用います。

##### 導入について

##### Firebase セキュリティ ルール

#### REST API: Firebase Cloud Functions

## my spreadのデプロイ手順
